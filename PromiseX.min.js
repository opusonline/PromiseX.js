/**
 * PromiseX - Promise Xtended
 * wrapper for promises to add new methods w/o changing the native promise prototype
 * @author Stefan Benicke <stefan.benicke@gmail.com>
 * @version 2.0.0
 * @see {@link https://github.com/opusonline/PromiseX.js}
 * @license MIT
 */
!function(n,t){function e(){function l(n,e){if(!E(this))throw new TypeError("Failed to construct 'PromiseX': Please use the 'new' operator, this object constructor cannot be called as a function.");if(E(n))return n;var r=this;return this.status=l.PENDING,this.value=t,y(),n instanceof d?(this.promise=n.then(function(n){return r.status=l.RESOLVED,r.value=n,n},function(n){throw r.status=l.REJECTED,r.value=n,n}),this):(n===t&&(this.resolve=null,this.reject=null,n=function(n,t,e){e.resolve=function(t){return n(t),e},e.reject=function(n){return t(n),e}}),c(n)?(e===t&&(e=r),this.promise=new d(function(t,o){try{n.call(e,function(n){r.status===l.PENDING&&(r.status=l.RESOLVED,r.value=n,t(n))},function(n){r.status===l.PENDING&&(r.status=l.REJECTED,r.value=n,o(n))},r)}catch(i){r.status===l.PENDING&&(r.status=l.REJECTED,r.value=i,o(i))}}),this):(this.promise=p(n),this.status=l.RESOLVED,void(this.value=n)))}function m(n,e,r){if(r!==t&&a(n,"message",""+r),"captureStackTrace"in Error)Error.captureStackTrace(n,e);else{var o=new Error(r);f?this.stack=o.stack:Object.defineProperty(n,"stack",{set:function(n){return o.stack=n,o.stack},get:function(){return o.stack},enumerable:!1,configurable:!0})}}function p(n){return n instanceof d?n:d.resolve(n)}function v(n){return E(n)?n.promise:p(n)}function E(n){return n instanceof l}function w(n){n===t&&(n=d);try{var e=new n(function(n,t){});return"then"in e&&typeof e.then===h}catch(r){}return!1}function y(){if(!T)throw new TypeError('Base Promise needed but is undefined. Use PromiseX.config("setPromise", whateverPromise) or "createPromise".')}var d=n.Promise,T=!0;l.PENDING="pending",l.RESOLVED="resolved",l.REJECTED="rejected";var P=l.prototype;return a(P,"status",l.PENDING),a(P,"value",t),a(P,"then",function(n,t,e){var r=c(n)?function(t){if(o(t))return t;var r=n.call(e,t);return E(r)?r.promise:r}:n,i=c(t)?function(n){var r=t.call(e,n);return E(r)?r.promise:r}:t,u=this.promise.then(r,i);return new l(u)}),a(P,"catch",function(n,t){var e;return e=c(n)?this.promise["catch"](function(e){var r=n.call(t,e);return E(r)?r.promise:r}):this.promise["catch"](n),new l(e)}),a(P,"finally",function(n,e){var r=this.promise.then(function(r){var o=n.call(e);return v(o).then(function(n){return n!==t?n:r})},function(r){var o=n.call(e);return v(o).then(function(n){if(n!==t)return n;throw r})});return new l(r)}),a(P,"done",function(n,t,e){this.then(n,t,e)["catch"](function(n){s(function(){throw n})})}),a(P,"nodeify",function(n,t){return c(n)?(this.promise.then(function(e){s(function(){n.call(t,null,e)})},function(e){s(function(){n.call(t,e)})}),this):this}),a(P,"delay",function(n){var t=this.promise.then(function(t){return new d(function(e){setTimeout(function(){e(t)},n)})},function(t){return new d(function(e,r){setTimeout(function(){r(t)},n)})});return new l(t)}),a(P,"cancelled",function(n,e){var r=c(n)?function(r){if(o(r)){var i=n.call(e,r.reason);if(i!==t)return E(i)?i.promise:i}return r}:n,i=this.promise.then(r);return new l(i)}),a(l,"resolve",function(n){return E(n)?n:new l(function(t){t(n)})}),a(l,"reject",function(n){return new l(function(t,e){e(n)})}),a(l,"timeout",function(n,t,e){return new l(function(r,o){setTimeout(function(){o(new l.TimeoutError(e||"Timeout"))},t),n.then(r,o)})}),a(l,"delay",function(n,t){return new l(function(e){setTimeout(function(){e(t)},n)})}),a(l,"defer",function(){return new l}),a(l,"cast",function(n){return E(n)?n:(n===t&&(y(),n=p()),new l(n))}),a(l,"all",function(n){return new l(function(e,r){function u(n){o(n)?e(n):c.push(n)}if(n===t||null===n)throw new TypeError("First argument needs to be an array of promises or values.");var c=[],a=p();i(n,function(n){n=v(n)["catch"](r),a=a.then(function(){return n.then(u)})}),a.then(function(){e(c)})})}),a(l,"race",function(n){return new l(function(e,r){if(n===t||null===n)throw new TypeError("First argument needs to be an array of promises or values.");if(u(n)){var o,i=n.length;if(0===i)return e();for(o=0;i>o;o++)v(n[o]).then(e,r)}else v(n).then(e,r)})}),a(l,"every",function(n){return new l(function(e){function r(){c--,0===c&&e(a)}if(n===t||null===n)throw new TypeError("First argument needs to be an array of promises or values.");var c=u(n)?n.length:1,a=new Array(c);return 0===c?e(a):void i(n,function(n,t){function i(){n.status===l.RESOLVED&&o(n.value)?e(n.value):(a[t]=n,r())}n=l.cast(n),n.promise.then(i,i)})})}),a(l,"any",function(n){return new l(function(e,r){function o(){i--,0===i&&r(new Error("No promises resolved successfully."))}if(n===t||null===n)throw new TypeError("First argument needs to be an array of promises or values.");if(u(n)){var i=n.length;if(0===i)return e();var c,a;for(c=0,a=i;a>c;c++)v(n[c]).then(e,o)}else v(n).then(e,r)})}),a(l,"map",function(n,t,e){if(!c(t))throw new TypeError("Map-function is no valid function");u(n)===!1&&(n=[n]);var r,o=[],i=n.length;for(r=0;i>r;r++)o.push(l.cast(t.call(e,n[r],r,i,n)));return o}),a(l,"reduce",function(n,t,e,r){return new l(function(a,s){if(!c(t))throw new TypeError("Reduce-function is no valid function");var f=u(n)?n.length:1,l=v(e);i(n,function(e,i){l=l.then(function(u){if(o(u))return u;var c=t.call(r,u,e,i,f,n);return E(c)?c.promise:c})}),l.then(a,s)})}),a(l,"cancel",function(n){var t=new r(n);return new l(t)}),a(l,"config",function(n,r){if("getPromise"===n)return d;if("setPromise"===n&&r!==t){if(!w(r))throw new TypeError(" Invalid Promise: "+r);return d=r,!0}if("createPromise"===n&&r!==t){if(!w(r))throw new TypeError(" Invalid Promise: "+r);var o=e();return o.config("setPromise",r),o}return!1}),a(l,"CancellationError",function(n){return this instanceof l.CancellationError?void m(this,l.CancellationError,n):new l.CancellationError(n)}),a(l.CancellationError.prototype,"message",""),a(l,"TimeoutError",function(n){return this instanceof l.TimeoutError?void m(this,l.TimeoutError,n):new l.TimeoutError(n)}),a(l.TimeoutError.prototype,"message",""),T=w(),l}function r(n){n!==t&&a(this,"reason",n)}function o(n){return n instanceof r}function i(n,t,e){if(u(n)===!1&&(n=[n]),typeof Array.prototype.forEach===h)return n.forEach(t,e);var r,o;for(r=0,o=n.length;o>r;r++)t.call(e,n[r],r,n)}function u(n){return typeof Array.isArray===h?Array.isArray(n):"[object Array]"===Object.prototype.toString.call(n)}function c(n){return typeof n===h}var a,s=n.setImmediate||function(n){return setTimeout(n,0)},f=!1;try{Object.defineProperty({},"x",{}),a=function(n,t,e){return Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!1,configurable:!0})}}catch(l){f=!0,a=function(n,t,e){return n[t]=e,n}}var h="function",m=e();typeof define===h&&define.amd?define(function(){return m}):"undefined"!=typeof module?module.exports=m:n.PromiseX=m}(this);