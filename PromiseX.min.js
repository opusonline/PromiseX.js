/**
 * opusonline-promisex.js
 * Javascript Promise Xtended - Wrapper to add new methods w/o changing the native promise prototype
 * @author Stefan Benicke <stefan.benicke@gmail.com>
 * @version 2.0.0
 * @see {@link https://github.com/opusonline/PromiseX.js.git}
 * @license MIT
 */
!function(n,t){"use strict";function e(){function n(e,r){if(!E(this))throw new TypeError("Failed to construct 'PromiseX': Please use the 'new' operator, this object constructor cannot be called as a function.");if(E(e))return e;var o=this;return this.status=n.PENDING,this.value=t,d(),e instanceof T?(this.promise=e.then(function(t){return o.status=n.RESOLVED,o.value=t,t},function(t){throw o.status=n.REJECTED,o.value=t,t}),this):(e===t&&(this.resolve=null,this.reject=null,e=function(n,t,e){e.resolve=function(t){return n(t),e},e.reject=function(n){return t(n),e}}),a(e)?(r===t&&(r=o),this.promise=new T(function(t,u){try{e.call(r,function(e){o.status===n.PENDING&&(i(o,e),o.status=n.RESOLVED,o.value=e,t(e))},function(t){o.status===n.PENDING&&(i(o,t),o.status=n.REJECTED,o.value=t,u(t))},o)}catch(c){o.status===n.PENDING&&(o.status=n.REJECTED,o.value=c,u(c))}}),this):(this.promise=v(e),this.status=n.RESOLVED,void(this.value=e)))}function p(n,e,r){if(r!==t&&s(n,"message",""+r),"captureStackTrace"in Error)Error.captureStackTrace(n,e);else{var o=new Error(r);m?this.stack=o.stack:Object.defineProperty(n,"stack",{set:function(n){return o.stack=n,o.stack},get:function(){return o.stack},enumerable:!1,configurable:!0})}}function v(n){return n instanceof T?n:T.resolve(n)}function w(n){return E(n)?n.promise:v(n)}function E(t){return t instanceof n}function y(n){n===t&&(n=T);try{var e=new n(function(n,t){});return"then"in e&&typeof e.then===l}catch(r){}return!1}function d(){if(!g)throw new TypeError('Base Promise needed but is undefined. Use PromiseX.config("setPromise", whateverPromise) or "createPromise".')}var T=f.Promise,g=y();n.PENDING="pending",n.RESOLVED="resolved",n.REJECTED="rejected";var P=n.prototype;return s(P,"status",n.PENDING),s(P,"value",t),s(P,"then",function(t,e,r){var u,c,s=a(t)?function(n){if(o(n))return n;var e=t.call(r,n);return i(u,e),E(e)?e.promise:e}:t,f=a(e)?function(n){var t=e.call(r,n);return i(u,t),E(t)?t.promise:t}:e;return c=this.promise.then(s,f),u=new n(c)}),s(P,"catch",function(t,e){var r,o;return o=a(t)?this.promise["catch"](function(n){var o=t.call(e,n);return i(r,o),E(o)?o.promise:o}):this.promise["catch"](t),r=new n(o)}),s(P,"finally",function(e,r){var o,u=this.promise.then(function(n){var u=e.call(r);return i(o,u),w(u).then(function(e){return e!==t?e:n})},function(n){var u=e.call(r);return i(o,u),w(u).then(function(e){if(e!==t)return e;throw n})});return o=new n(u)}),s(P,"done",function(n,t,e){this.then(n,t,e)["catch"](function(n){h(function(){throw n})})}),s(P,"nodeify",function(n,t){return a(n)?(this.promise.then(function(e){h(function(){n.call(t,null,e)})},function(e){h(function(){n.call(t,e)})}),this):this}),s(P,"delay",function(t){var e=this.promise.then(function(n){return new T(function(e){setTimeout(function(){e(n)},t)})},function(n){return new T(function(e,r){setTimeout(function(){r(n)},t)})});return new n(e)}),s(P,"cancelled",function(e,r){var u,c=a(e)?function(n){if(o(n)){var c=e.call(r,n.reason);if(c!==t)return i(u,c),E(c)?c.promise:c}return n}:e,s=this.promise.then(c);return u=new n(s)}),s(n,"resolve",function(t){return E(t)?t:new n(function(n){n(t)})}),s(n,"reject",function(t){return new n(function(n,e){e(t)})}),s(n,"timeout",function(t,e,r){return new n(function(o,i){setTimeout(function(){i(new n.TimeoutError(r||"Timeout"))},e),t.then(o,i)})}),s(n,"delay",function(t,e){return new n(function(n){setTimeout(function(){n(e)},t)})}),s(n,"defer",function(){return new n}),s(n,"cast",function(e){return E(e)?e:(e===t&&(d(),e=v()),new n(e))}),s(n,"all",function(e){return new n(function(n,r){function i(t){o(t)?n(t):c.push(t)}if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");var c=[],a=v();u(e,function(n){n=w(n)["catch"](r),a=a.then(function(){return n.then(i)})}),a.then(function(){n(c)})})}),s(n,"race",function(e){return new n(function(n,r){if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");if(c(e)){var o,i=e.length;if(0===i)return n();for(o=0;i>o;o++)w(e[o]).then(n,r)}else w(e).then(n,r)})}),s(n,"every",function(e){return new n(function(r){function i(){a--,0===a&&r(s)}if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");var a=c(e)?e.length:1,s=new Array(a);return 0===a?r(s):void u(e,function(t,e){function u(){t.status===n.RESOLVED&&o(t.value)?r(t.value):(s[e]=t,i())}t=n.cast(t),t.promise.then(u,u)})})}),s(n,"any",function(e){return new n(function(n,r){if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");if(c(e)){var o=e.length;if(0===o)return n();var i,u,a=function(){o--,0===o&&r(new Error("No promises resolved successfully."))};for(i=0,u=o;u>i;i++)w(e[i]).then(n,a)}else w(e).then(n,r)})}),s(n,"map",function(t,e,r){if(!a(e))throw new TypeError("Map-function is no valid function");c(t)===!1&&(t=[t]);var o,i=[],u=t.length;for(o=0;u>o;o++)i.push(n.cast(e.call(r,t[o],o,u,t)));return i}),s(n,"reduce",function(t,e,r,i){return new n(function(n,s){if(!a(e))throw new TypeError("Reduce-function is no valid function");var f=c(t)?t.length:1,l=w(r);u(t,function(n,r){l=l.then(function(u){if(o(u))return u;var c=e.call(i,u,n,r,f,t);return E(c)?c.promise:c})}),l.then(n,s)})}),s(n,"cancel",function(t){var e=new r(t);return new n(e)}),s(n,"config",function(n,r){if("getPromise"===n)return T;if("setPromise"===n&&r!==t){if(!y(r))throw new TypeError(" Invalid Promise: "+r);return T=r,!0}if("createPromise"===n&&r!==t){if(!y(r))throw new TypeError(" Invalid Promise: "+r);var o=e();return o.config("setPromise",r),o}return!1}),s(n,"CancellationError",function(t){return this instanceof n.CancellationError?void p(this,n.CancellationError,t):new n.CancellationError(t)}),s(n.CancellationError.prototype,"message",""),s(n,"TimeoutError",function(t){return this instanceof n.TimeoutError?void p(this,n.TimeoutError,t):new n.TimeoutError(t)}),s(n.TimeoutError.prototype,"message",""),n}function r(n){n!==t&&s(this,"reason",n)}function o(n){return n instanceof r}function i(n,t){if(n===t)throw new TypeError("Attempt to resolve promise with self")}function u(n,t,e){if(c(n)===!1&&(n=[n]),typeof Array.prototype.forEach===l)return n.forEach(t,e);var r,o;for(r=0,o=n.length;o>r;r++)t.call(e,n[r],r,n)}function c(n){return typeof Array.isArray===l?Array.isArray(n):"[object Array]"===Object.prototype.toString.call(n)}function a(n){return typeof n===l}var s,f="object"==typeof global&&global!==n.global?global:n,l="function",h=typeof f.setImmediate===l?f.setImmediate:function(n){return setTimeout(n,0)},m=!1;try{Object.defineProperty({},"x",{}),s=function(n,t,e){return Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!1,configurable:!0})}}catch(p){m=!0,s=function(n,t,e){return n[t]=e,n}}var v=e();typeof f.define===l&&f.define.amd?f.define([],function(){return v}):"undefined"!=typeof module&&n.module!==module?module.exports=v:f.PromiseX=v}(this);