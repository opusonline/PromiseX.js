/**
 * opusonline-promisex.js
 * Javascript Promise Xtended - Wrapper to add new methods w/o changing the native promise prototype
 * @author Stefan Benicke <stefan.benicke@gmail.com>
 * @version 2.2.0
 * @see {@link https://github.com/opusonline/PromiseX.js.git}
 * @license MIT
 */
!function(n,t){"use strict";function e(){function n(e,r){var o;if(!E(this))throw new TypeError("Failed to construct 'PromiseX': Please use the 'new' operator, this object constructor cannot be called as a function.");return E(e)?e:(o=this,this.status=n.PENDING,this.value=t,d(),e instanceof g?(this.promise=e.then(function(t){return o.status=n.RESOLVED,o.value=t,t},function(t){throw o.status=n.REJECTED,o.value=t,t}),this):(e===t&&(this.resolve=null,this.reject=null,e=function(n,t,e){e.resolve=function(t){return n(t),e},e.reject=function(n){return t(n),e}}),s(e)?(r===t&&(r=o),this.promise=new g(function(t,u){try{e.call(r,function(e){o.status===n.PENDING&&(i(o,e),o.status=n.RESOLVED,o.value=e,t(e))},function(t){o.status===n.PENDING&&(i(o,t),o.status=n.REJECTED,o.value=t,u(t))},o)}catch(c){o.status===n.PENDING&&(o.status=n.REJECTED,o.value=c,u(c))}}),this):(this.promise=v(e),this.status=n.RESOLVED,void(this.value=e))))}function f(n,e,r){var o;r!==t&&a(n,"message",""+r),"captureStackTrace"in Error?Error.captureStackTrace(n,e):(o=new Error(r),p?this.stack=o.stack:Object.defineProperty(n,"stack",{set:function(n){return o.stack=n,o.stack},get:function(){return o.stack},enumerable:!1,configurable:!0}))}function v(n){return n instanceof g?n:g.resolve(n)}function w(n){return E(n)?n.promise:v(n)}function E(t){return t instanceof n}function y(n){var e;n===t&&(n=g);try{return e=new n(function(n,t){}),"then"in e&&typeof e.then===h}catch(r){}return!1}function d(){if(!P)throw new TypeError('Base Promise needed but is undefined. Use PromiseX.config("setPromise", whateverPromise) or "createPromise".')}var T,g=l.Promise,P=y();return n.PENDING="pending",n.RESOLVED="resolved",n.REJECTED="rejected",T=n.prototype,a(T,"status",n.PENDING),a(T,"value",t),a(T,"then",function(t,e,r){var u,c,a=s(t)?function(n){var e;return o(n)?n:(e=t.call(r,n),i(u,e),E(e)?e.promise:e)}:t,f=s(e)?function(n){var t=e.call(r,n);return i(u,t),E(t)?t.promise:t}:e;return c=this.promise.then(a,f),u=new n(c)}),a(T,"catch",function(t,e){var r,o;return o=s(t)?this.promise["catch"](function(n){var o=t.call(e,n);return i(r,o),E(o)?o.promise:o}):this.promise["catch"](t),r=new n(o)}),a(T,"finally",function(e,r){var u,c=this.promise.then(function(n){var c;return o(n)?n:(c=e.call(r),i(u,c),w(c).then(function(e){return e!==t?e:n}))},function(n){var o=e.call(r);return i(u,o),w(o).then(function(e){if(e!==t)return e;throw n})});return u=new n(c)}),a(T,"done",function(n,t,e){this.then(n,t,e)["catch"](function(n){m(function(){throw n})})}),a(T,"nodeify",function(n,t){return s(n)?(this.promise.then(function(e){o(e)||m(function(){n.call(t,null,e)})},function(e){m(function(){n.call(t,e)})}),this):this}),a(T,"delay",function(t){var e=this.promise.then(function(n){return o(n)?n:new g(function(e){setTimeout(function(){e(n)},t)})},function(n){return new g(function(e,r){setTimeout(function(){r(n)},t)})});return new n(e)}),a(T,"cancelled",function(e,r){var u,c=s(e)?function(n){var c;return o(n)&&(c=e.call(r,n.reason),c!==t)?(i(u,c),E(c)?c.promise:c):n}:e,a=this.promise.then(c);return u=new n(a)}),a(n,"resolve",function(t){return E(t)?t:new n(function(n){n(t)})}),a(n,"reject",function(t){return new n(function(n,e){e(t)})}),a(n,"timeout",function(t,e,r){return new n(function(o,i){setTimeout(function(){i(new n.TimeoutError(r||"Timeout"))},e),t.then(o,i)})}),a(n,"delay",function(t,e){return new n(function(n){setTimeout(function(){n(e)},t)})}),a(n,"defer",function(){return new n}),a(n,"cast",function(e){return E(e)?e:(e===t&&(d(),e=v()),new n(e))}),a(n,"all",function(e){return new n(function(n,r){function i(t){o(t)?n(t):c.push(t)}var c,s;if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");c=[],s=v(),u(e,function(n){n=w(n)["catch"](r),s=s.then(function(){return n.then(i)})}),s.then(function(){n(c)})})}),a(n,"race",function(e){return new n(function(n,r){var o,i;if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");if(c(e)){if(i=e.length,0===i)return n();for(o=0;i>o;o++)w(e[o]).then(n,r)}else w(e).then(n,r)})}),a(n,"every",function(e){return new n(function(r){function i(){s--,0===s&&r(a)}var s,a;if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");return s=c(e)?e.length:1,a=new Array(s),0===s?r(a):void u(e,function(t,e){function u(){t.status===n.RESOLVED&&o(t.value)?r(t.value):(a[e]=t,i())}t=n.cast(t),t.promise.then(u,u)})})}),a(n,"any",function(e){return new n(function(n,r){var o,i,u,s;if(e===t||null===e)throw new TypeError("First argument needs to be an array of promises or values.");if(c(e)){if(o=e.length,0===o)return n();for(i=function(){o--,0===o&&r(new Error("No promises resolved successfully."))},u=0,s=o;s>u;u++)w(e[u]).then(n,i)}else w(e).then(n,r)})}),a(n,"map",function(t,e,r){var o,i,u;if(!s(e))throw new TypeError("Map-function is no valid function");for(c(t)===!1&&(t=[t]),o=[],u=t.length,i=0;u>i;i++)o.push(n.cast(e.call(r,t[i],i,u,t)));return o}),a(n,"reduce",function(t,e,r,i){return new n(function(n,a){var f,l;if(!s(e))throw new TypeError("Reduce-function is no valid function");f=c(t)?t.length:1,l=w(r),u(t,function(n,r){l=l.then(function(u){var c;return o(u)?u:(c=e.call(i,u,n,r,f,t),E(c)?c.promise:c)})}),l.then(n,a)})}),a(n,"cancel",function(t){var e=new r(t);return new n(e)}),a(n,"config",function(n,r){var o;if("getPromise"===n)return g;if("setPromise"===n&&r!==t){if(!y(r))throw new TypeError(" Invalid Promise: "+r);return g=r,P=y(),!0}if("createPromise"===n&&r!==t){if(!y(r))throw new TypeError(" Invalid Promise: "+r);return o=e(),o.config("setPromise",r),o}return!1}),a(n,"CancellationError",function(t){return this instanceof n.CancellationError?void f(this,n.CancellationError,t):new n.CancellationError(t)}),a(n.CancellationError.prototype,"message",""),a(n,"TimeoutError",function(t){return this instanceof n.TimeoutError?void f(this,n.TimeoutError,t):new n.TimeoutError(t)}),a(n.TimeoutError.prototype,"message",""),n}function r(n){n!==t&&a(this,"reason",n)}function o(n){return n instanceof r}function i(n,t){if(n===t)throw new TypeError("Attempt to resolve promise with self")}function u(n,t,e){var r,o;if(c(n)===!1&&(n=[n]),typeof Array.prototype.forEach===h)return n.forEach(t,e);for(r=0,o=n.length;o>r;r++)t.call(e,n[r],r,n)}function c(n){return typeof Array.isArray===h?Array.isArray(n):"[object Array]"===Object.prototype.toString.call(n)}function s(n){return typeof n===h}var a,f,l="object"==typeof global&&global!==n.global?global:n,h="function",m=typeof l.setImmediate===h?l.setImmediate:function(n){return setTimeout(n,0)},p=!1;try{Object.defineProperty({},"x",{}),a=function(n,t,e){return Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!1,configurable:!0})}}catch(v){p=!0,a=function(n,t,e){return n[t]=e,n}}f=e(),typeof l.define===h&&l.define.amd?l.define([],function(){return f}):"undefined"!=typeof module&&n.module!==module?module.exports=f:l.PromiseX=f}(this);