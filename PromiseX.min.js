/*!
 * PromiseX - Promise Xtended
 * wrapper for promises to add new methods w/o changing the native promise prototype
 * good read: http://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
 * also interesting: https://github.com/paldepind/sync-promise
 * @author Stefan Benicke <stefan.benicke@gmail.com>
 * @version 1.0.0
 * @see {@link https://github.com/opusonline/PromiseX.js}
 * @license MIT
 */
!function(n,t){function e(n,o){if(!(this instanceof e))throw new TypeError("Failed to construct 'PromiseX': Please use the 'new' operator, this object constructor cannot be called as a function.");if(n instanceof e)return n;var i=this;return this.status=e.PENDING,this.value=t,n instanceof f?(this.promise=n.then(function(n){return i.status=e.RESOLVED,i.value=n,n},function(n){throw i.status=e.REJECTED,i.value=n,n}),this):(typeof n===a&&(this.resolve=null,this.reject=null,n=function(n,t,e){e.resolve=function(t){return n(t),e},e.reject=function(n){return t(n),e}}),typeof n===l?(typeof o===a&&(o=i),this.promise=new f(function(t,r){try{n.call(o,function(n){i.status===e.PENDING&&(i.status=e.RESOLVED,i.value=n,t(n))},function(n){i.status===e.PENDING&&(i.status=e.REJECTED,i.value=n,r(n))},i)}catch(u){i.status===e.PENDING&&(i.status=e.REJECTED,i.value=u,r(u))}}),this):(this.promise=r(n),this.status=e.RESOLVED,void(this.value=n)))}function r(n){return n instanceof f?n:f.resolve(n)}function o(n){typeof n===a&&(n=f);try{var t=new n(function(n,t){});return"then"in t&&typeof t.then===l}catch(e){}return!1}function i(n,t,e){if(u(n)===!1&&(n=[n]),Array.prototype.forEach)return n.forEach(t,e);var r,o;for(r=0,o=n.length;o>r;r++)t.call(e,n[r],r,n)}function u(n){return Array.isArray?Array.isArray(n):"[object Array]"===Object.prototype.toString.call(n)}var f=n.Promise,c=n.setImmediate||function(n){return setTimeout(n,0)},s=function(){try{return Object.defineProperty({},"x",{}),function(n,t,e){return Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!1,configurable:!0})}}catch(n){}return function(n,t,e){return n[t]=e,n}}(),a="undefined",l="function";e.PENDING="pending",e.RESOLVED="resolved",e.REJECTED="rejected";var h=e.prototype;s(h,"status",e.PENDING),s(h,"value",t),s(h,"then",function(n,t,r){var o;if(typeof r!==a){var i=typeof n!==l?n:function(t){return n.call(r,t)},u=typeof t!==l?t:function(n){return t.call(r,n)};o=this.promise.then(i,u)}else o=this.promise.then(n,t);return new e(o)}),s(h,"catch",function(n,t){var r;if(typeof t!==a){var o=typeof n!==l?n:function(e){return n.call(t,e)};r=this.promise["catch"](o)}else r=this.promise["catch"](n);return new e(r)}),s(h,"finally",function(n,t){var o=this,i=this.promise.then(function(e){return r(n.call(t,o)).then(function(){return e})},function(e){return r(n.call(t,o)).then(function(){throw e})});return new e(i)}),s(h,"done",function(n,t,e){this.then(n,t,e)["catch"](function(n){c(function(){throw n})})}),s(h,"nodeify",function(n,t){return typeof n!==l?this:(this.promise.then(function(e){c(function(){n.call(t,null,e)})},function(e){c(function(){n.call(t,e)})}),this)}),s(h,"timeout",function(n,t){var r=this;return new e(function(e,o){setTimeout(function(){o(typeof t!==a?t:new Error("Timeout"))},n),r.promise.then(e,o)})}),s(h,"delay",function(n,t){var r=this.promise.then(function(e){return typeof t!==a&&(e=t),new f(function(t){setTimeout(function(){t(e)},n)})},function(t){return new f(function(e,r){setTimeout(function(){r(t)},n)})});return new e(r)}),s(e,"resolve",function(n){return n instanceof e?n:new e(function(t){t(n)})}),s(e,"reject",function(n){return new e(function(t,e){e(n)})}),s(e,"delay",function(n,t){return new e(function(e){setTimeout(function(){e(t)},n)})}),s(e,"defer",function(){return new e}),s(e,"cast",function(n){return n instanceof e?n:new e(n)}),s(e,"all",function(n){return new e(function(t,e){f.all(n).then(t,e)})}),s(e,"race",function(n){return new e(function(t,e){if(typeof n===a||null===n)throw new TypeError("First argument needs to be an array of promises.");if(u(n)){var o,i=n.length;if(0===i)return t();for(o=0;i>o;o++)r(n[o]).then(t,e)}else t(n)})}),s(e,"every",function(n){return new e(function(t){if(typeof n===a||null===n)throw new TypeError("First argument needs to be an array of promises.");u(n)===!1&&(n=[n]);var r=n.length,o=new Array(r);if(0===r)return t(o);var f=function(){r--,0===r&&t(o)};i(n,function(n,t){n=e.cast(n);var r=function(){o[t]=n,f()};n.then(r,r)})})}),s(e,"any",function(n){return new e(function(t,e){if(typeof n===a||null===n)throw new TypeError("First argument needs to be an array of promises.");if(u(n)){var o=!1,i=n.length;if(0===i)return t();var f,c,s=function(n){o=!0,i--,t(n)},l=function(){i--,0!==i||o||e(new Error("No promises resolved successfully."))};for(f=0,c=i;c>f;f++)r(n[f]).then(s,l)}else t(n)})}),s(e,"map",function(n,t,r){if(typeof t!==l)throw new TypeError("Map-function is no valid function");u(n)===!1&&(n=[n]);var o,i=[],f=n.length;for(o=0;f>o;o++)i.push(e.cast(t.call(r,n[o],o,f,n)));return i}),s(e,"config",function(n,t){if("getPromise"===n)return f;if("setPromise"===n&&typeof t!==a){if(o(t)===!1)throw new TypeError(" Invalid Promise: "+t.toString());return f=t,!0}return!1}),typeof define===l&&define.amd?define(function(){return e}):typeof module!==a?module.exports=e:n.PromiseX=e}(this);